<!DOCTYPE html>
<html>
	<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 80%;
      				width: 50%;}
    </style>



		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8ydWcT7L0z-S-g7DJf0Nh985GSMDjSf0&sensor=false&region=FR">
		</script>
		<script>
			function initialize(arrayCoordinates){

				var mapOptions = {
					center: new google.maps.LatLng(arrayCoordinates[0].lat, arrayCoordinates[0].lon), // On met la carte sur le premier point du parcours
					zoom: 12
				};
			
				map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

				var ramblePathCoordinates = new Array();

				for(var i=0; i < arrayCoordinates.length; i++){
					ramblePathCoordinates.push(new google.maps.LatLng(arrayCoordinates[i].lat, arrayCoordinates[i].lon));
				}


				var ramblePath = new google.maps.Polyline({
					path: ramblePathCoordinates,
					strokeColor: '#0000FF',
					strokeOpacity: 0.8,
					strokeWeight: 4
				});

				ramblePath.setMap(map);
			}
		</script>

	</head>
		<body>
		<h1>Chargement et affichage GPX</h1>
		<form id="formLoadGPX">
			<input id="fileMap" type="file">
		</form>


		<div id="map-canvas"/>

		<script type="text/javascript">
			var fileInput = document.querySelector('#fileMap');

		   		fileInput.onchange = function() {
    			var reader = new FileReader();
    			
    			reader.onload = function() {
    				if(window.DOMParser){
    					parser = new DOMParser();
    					gpxFile = parser.parseFromString(reader.result, "text/xml");
    				}
    				else{ // Si on est sur IE
    					gpxFile = new ActiveXObject("Microsoft.XMLDOM");
  						gpxFile.async=false;
  						gpxFile.loadXML(reader.result); 
    				}

    				var listCoordinates = new Array();
    				var Coordinate = { // Longitude et lattitude
    					lat: NaN,
    					lon: NaN
    				}; 
    				var listPoints = gpxFile.getElementsByTagName('trkpt');
    				var listAttributes;
    				var i; // Nous permettra de calculer le nombre de points


    				for(var i=0; i< listPoints.length; i++){

    					listAttributes = listPoints[i].attributes;
    					for(var j=0; j < listAttributes.length; j++){
    						if(listAttributes[j].nodeName == 'lon'){
    							Coordinate.lon = parseFloat(listAttributes[j].nodeValue);
    						}
    						else if(listAttributes[j].nodeName == 'lat'){
    							Coordinate.lat = parseFloat(listAttributes[j].nodeValue);
    						}
    					}

    					if(Coordinate.lat != NaN && Coordinate.lon != NaN){ // Si la coordonnée est valide
    						listCoordinates.push(Coordinate);
    					}

    					Coordinate = { // Longitude et lattitude
	    					lat: NaN,
	    					lon: NaN
    					}; 
    				}

    				infoFile = document.createElement('div');
    				var p = document.createElement('p');
    				infoFile.id = 'info-map';

    				if(listCoordinates.length > 0){
    					initialize(listCoordinates); // On appelle la carte
	    				var h3 = document.createElement('h3');
	    				

	    				p.innerHTML = '<strong>Nom du fichier</strong> : ' + fileInput.files[0].name + '<br><strong>Nombre de points</strong> : ' + i + '<br>';
	    				h3.appendChild(document.createTextNode('Informations fichier : '));
	    				infoFile.appendChild(h3);
	    				infoFile.appendChild(p);
	    				
	    				
    				}
    				else{
    					p.appendChild(document.createTextNode('Erreur : Le fichier que vous avez choisi ne contient aucune coordonée'));
    					p.id = 'erreur';
    				}


    				divInfo = document.getElementById('info-map');
    				if(divInfo == null){
    					document.body.insertBefore(infoFile, document.getElementById('map-canvas')); // On insère les infos avant la carte
    				}
    				else{
    					document.body.replaceChild(infoFile, divInfo);
    				}

    			};


    			reader.readAsText(fileInput.files[0]);
    		}
		</script>
	</body>
</html>
